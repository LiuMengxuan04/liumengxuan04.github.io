---
layout:     post
title:      "RoCE v1 åè®®æ¶æ„æ·±åº¦è§£æä¸ ns-3 ä»¿çœŸå®ç°ç­–ç•¥"
subtitle:   "RoCE v1 åè®®æ¶æ„æ·±åº¦è§£æä¸ ns-3 ä»¿çœŸå®ç°ç­–ç•¥"
date:       2025-12-29 23:17:00 +0800
author:     "Liu Mengxuan"
mathjax: true
header-img: "img/post-bg-miui6.jpg"
categories: [æŠ€æœ¯]
tags: [æŠ€æœ¯, ç½‘ç»œ, æ•°æ®ä¸­å¿ƒ]
---
ğŸ“Š **æ‰©å±•é˜…è¯»**ï¼šä¸ºäº†æ›´ç›´è§‚åœ°ç†è§£ï¼Œä½ å¯ä»¥æŸ¥çœ‹ [RoCE v1åˆ†ææŠ¥å‘Š](/static_post/RoCE_v1_NS3_Guide.html) é¡µé¢ã€‚
# **RoCE v1 åè®®æ¶æ„æ·±åº¦è§£æä¸ ns-3 ä»¿çœŸå®ç°ç­–ç•¥**

## **1\. å¼•è¨€**

éšç€æ•°æ®ä¸­å¿ƒå¯¹é«˜æ€§èƒ½è®¡ç®—ï¼ˆHPCï¼‰å’Œå¤§è§„æ¨¡åˆ†å¸ƒå¼å­˜å‚¨éœ€æ±‚çš„æ¿€å¢ï¼Œç½‘ç»œäº’è¿æŠ€æœ¯æ­£ç»å†ç€ä»ä¼ ç»Ÿ TCP/IP å‘ä½å»¶è¿Ÿã€é«˜å¸¦å®½æ¶æ„çš„æ·±åˆ»è½¬å‹ã€‚è¿œç¨‹ç›´æ¥å†…å­˜è®¿é—®ï¼ˆRemote Direct Memory Access, RDMAï¼‰æŠ€æœ¯ï¼Œæœ€åˆä½œä¸º InfiniBandï¼ˆIBï¼‰ç½‘ç»œçš„æ ¸å¿ƒç‰¹æ€§ï¼Œé€šè¿‡â€œé›¶æ‹·è´â€ï¼ˆZero-copyï¼‰å’Œâ€œå†…æ ¸æ—è·¯â€ï¼ˆKernel-bypassï¼‰æœºåˆ¶ï¼Œå½»åº•æ”¹å˜äº†æœåŠ¡å™¨é—´çš„æ•°æ®ä¼ è¾“æ•ˆç‡ã€‚ç„¶è€Œï¼ŒInfiniBand æ˜‚è´µçš„ä¸“ç”¨ç¡¬ä»¶æˆæœ¬ä¿ƒä½¿äº† RDMA over Converged Ethernetï¼ˆRoCEï¼‰çš„è¯ç”Ÿã€‚RoCE æ—¨åœ¨åˆ©ç”¨æ— å¤„ä¸åœ¨çš„ä»¥å¤ªç½‘åŸºç¡€è®¾æ–½æ‰¿è½½ InfiniBand ä¼ è¾“åè®®ï¼Œä»è€Œåœ¨é€šç”¨ç¡¬ä»¶ä¸Šå®ç°è¿‘ä¼¼ HPC çº§åˆ«çš„ç½‘ç»œæ€§èƒ½ã€‚

æœ¬æŠ¥å‘Šæ—¨åœ¨å¯¹ RoCE v1 åè®®è¿›è¡Œè¯¦å°½çš„æŠ€æœ¯è§£æ„ï¼Œå¹¶é’ˆå¯¹å¼€æºç½‘ç»œä»¿çœŸå™¨ ns-3 ä¸­çš„ ns3-rdma é¡¹ç›®ï¼ˆåŸºäº RoCE v2ï¼‰æå‡ºç³»ç»Ÿçš„æ”¹é€ ä¸å®ç°æ–¹æ¡ˆã€‚æŠ¥å‘Šä¸ä»…æ¶µç›– RoCE v1 çš„åè®®æ ˆç»†èŠ‚ã€å¸§ç»“æ„å®šä¹‰åŠå…¶ä¸ InfiniBand çš„æ¸Šæºï¼Œè¿˜å°†æ·±å…¥ä»£ç å±‚é¢ï¼ŒæŒ‡å¯¼ç ”ç©¶äººå‘˜å¦‚ä½•é€šè¿‡ä¿®æ”¹ C++ æºç ï¼Œå°†ç°æœ‰çš„ UDP/IP å°è£…æ¶æ„å›é€€è‡³åŸºäºåŸå§‹ä»¥å¤ªç½‘ï¼ˆRaw Ethernetï¼‰çš„é“¾è·¯å±‚æ¶æ„ï¼Œä»è€Œåœ¨ ns-3 ç¯å¢ƒä¸­ç²¾ç¡®å¤ç° RoCE v1 çš„è¡Œä¸ºç‰¹å¾ã€‚

## ---

**2\. RoCE v1 åè®®å®ç°çš„æ·±åº¦è§£æ**

RoCE v1ï¼ˆRDMA over Converged Ethernet version 1ï¼‰æ˜¯ RDMA åè®®åœ¨ä»¥å¤ªç½‘ä¸Šçš„é¦–æ¬¡å°è¯•ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯ä¿ç•™ InfiniBand çš„ä¼ è¾“å±‚å’Œç½‘ç»œå±‚è¯­ä¹‰ï¼Œä½†å°†å…¶ç‰©ç†å±‚å’Œé“¾è·¯å±‚æ›¿æ¢ä¸ºæ ‡å‡†çš„ä»¥å¤ªç½‘ã€‚ç†è§£ RoCE v1 çš„å…³é”®åœ¨äºæŠŠæ¡å…¶â€œäºŒå±‚åè®®â€çš„æœ¬è´¨ï¼Œè¿™å†³å®šäº†å…¶åœ¨å¯»å€ã€è·¯ç”±åŠæµæ§æ–¹é¢çš„æ‰€æœ‰ç‰¹æ€§ã€‚

### **2.1 åè®®æ ˆæ¶æ„ä¸ EtherType å®šä¹‰**

ä¸æ„å»ºåœ¨ UDP/IP ä¹‹ä¸Šçš„ RoCE v2 ä¸åŒï¼ŒRoCE v1 æ˜¯ä¸€ä¸ªçº¯ç²¹çš„ä»¥å¤ªç½‘é“¾è·¯å±‚åè®®ã€‚åœ¨åè®®æ ˆä¸­ï¼Œå®ƒç›´æ¥ä½äºä»¥å¤ªç½‘ MAC å±‚ä¹‹ä¸Šï¼Œå®Œå…¨è·³è¿‡äº†ç½‘ç»œå±‚ï¼ˆIPï¼‰å’Œä¼ è¾“å±‚ï¼ˆUDP/TCPï¼‰ã€‚

#### **2.1.1 EtherType 0x8915 çš„ç¡®ç«‹**

åœ¨ä»¥å¤ªç½‘å¸§çš„å°è£…ä¸­ï¼Œä¸ºäº†åŒºåˆ†ä¸Šå±‚è´Ÿè½½æ˜¯ IP æ•°æ®åŒ…ï¼ˆ0x0800ï¼‰ã€ARP è¯·æ±‚ï¼ˆ0x0806ï¼‰è¿˜æ˜¯å…¶ä»–åè®®ï¼ŒIEEE ä¸º RoCE v1 åˆ†é…äº†ä¸“ç”¨çš„ä»¥å¤ªç½‘ç±»å‹ç ï¼ˆEtherTypeï¼‰ï¼š0x8915 1ã€‚

* **æœºåˆ¶åˆ†æ**ï¼šå½“ç½‘å¡ï¼ˆNICï¼‰æˆ–äº¤æ¢æœºæ¥æ”¶åˆ°ä¸€ä¸ªä»¥å¤ªç½‘å¸§æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥å¸§å¤´ä¸­çš„ EtherType å­—æ®µã€‚å¦‚æœè¯¥å€¼ä¸º 0x8915ï¼Œæ¥æ”¶ç«¯å³çŸ¥æ™“éšåçš„æœ‰æ•ˆè½½è·ï¼ˆPayloadï¼‰å¹¶éæ ‡å‡†çš„ IP æ•°æ®åŒ…ï¼Œè€Œæ˜¯ä¸€ä¸ªå°è£…äº† InfiniBand å¤´éƒ¨ç»“æ„ï¼ˆGRH \+ BTHï¼‰çš„ RDMA æ•°æ®åŒ…ã€‚  
* **å®ç°å«ä¹‰**ï¼šè¿™ä¸€è®¾è®¡æ„å‘³ç€ RoCE v1 æŠ¥æ–‡åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸å…·å¤‡ IP è·¯ç”±èƒ½åŠ›ã€‚å®ƒä¾èµ–ä»¥å¤ªç½‘äº¤æ¢æœºåŸºäº MAC åœ°å€è¡¨è¿›è¡Œè½¬å‘ï¼Œå› æ­¤é€šä¿¡èŒƒå›´è¢«ä¸¥æ ¼é™åˆ¶åœ¨åŒä¸€ä¸ªäºŒå±‚å¹¿æ’­åŸŸï¼ˆLayer 2 Broadcast Domainï¼‰æˆ– VLAN å†… 2ã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆ RoCE v1 æ— æ³•è·¨è¶Šè·¯ç”±å™¨è¿›è¡Œå¹¿åŸŸç½‘é€šä¿¡ã€‚

### **2.2 å¸§ç»“æ„ä¸å¤´éƒ¨å­—æ®µè¯¦è§£**

RoCE v1 çš„å¸§ç»“æ„æ˜¯â€œä»¥å¤ªç½‘å¤´ \+ IB ç½‘ç»œå±‚ \+ IB ä¼ è¾“å±‚ \+ æ•°æ®è´Ÿè½½ \+ æ ¡éªŒâ€çš„ç»„åˆã€‚å°½ç®¡ç§»é™¤äº† IP å¤´ï¼Œä½†ä¸ºäº†ä¿æŒä¸ InfiniBand ä¼ è¾“å±‚é€»è¾‘ï¼ˆVerbsï¼‰çš„å…¼å®¹æ€§ï¼ŒRoCE v1 å¼ºåˆ¶ä¿ç•™äº†å…¨å±€è·¯ç”±å¤´ï¼ˆGRHï¼‰ã€‚

#### **2.2.1 ä»¥å¤ªç½‘é“¾è·¯å±‚å¤´éƒ¨ (Ethernet L2 Header)**

è¿™æ˜¯æ ‡å‡†çš„ Ethernet II å¸§å¤´ï¼Œé•¿åº¦ä¸º 14 å­—èŠ‚ï¼š

* **ç›®çš„ MAC åœ°å€ (Destination MAC)**ï¼š6 å­—èŠ‚ã€‚  
* **æº MAC åœ°å€ (Source MAC)**ï¼š6 å­—èŠ‚ã€‚  
* **EtherType**ï¼š2 å­—èŠ‚ï¼Œå›ºå®šä¸º 0x8915ã€‚  
* **VLAN Tag (å¯é€‰)**ï¼šå¦‚æœé…ç½®äº† 802.1Q VLANï¼Œåˆ™ä¼šå¢åŠ  4 å­—èŠ‚çš„æ ‡ç­¾å­—æ®µï¼Œå…¶ä¸­åŒ…å« 3 ä½çš„ä¼˜å…ˆçº§ï¼ˆPCPï¼‰å­—æ®µï¼Œè¿™å¯¹ RoCE v1 çš„æµæ§è‡³å…³é‡è¦ 4ã€‚

#### **2.2.2 å…¨å±€è·¯ç”±å¤´ (Global Route Header, GRH)**

GRH æ˜¯ RoCE v1 ä¸­æœ€ä»¤äººå›°æƒ‘ä½†ä¹Ÿæœ€é‡è¦çš„éƒ¨åˆ†ã€‚å°½ç®¡ RoCE v1 ä¸è¿›è¡Œ IP è·¯ç”±ï¼Œä½† IB è§„èŒƒè¦æ±‚ä¼ è¾“å±‚å¿…é¡»èƒ½å¤„ç† GIDï¼ˆå…¨å±€æ ‡è¯†ç¬¦ï¼‰ã€‚å› æ­¤ï¼ŒRoCE v1 å€Ÿç”¨äº† GRH æ¥æ‰¿è½½ GID ä¿¡æ¯ã€‚GRH çš„æ ¼å¼ä¸ IPv6 å¤´éƒ¨å®Œå…¨ä¸€è‡´ï¼ˆ40 å­—èŠ‚ï¼‰ï¼Œä½†åœ¨ RDMA è¯­å¢ƒä¸‹å­—æ®µå«ä¹‰ç•¥æœ‰ä¸åŒ 6ã€‚

| å­—æ®µ (Field) | é•¿åº¦ (Bits) | IPv6 å¯¹åº”å­—æ®µ | RoCE v1 / IB å«ä¹‰ä¸ä½œç”¨ |
| :---- | :---- | :---- | :---- |
| **IP Version** | 4 | Version | å›ºå®šä¸º 6ã€‚ |
| **Traffic Class** | 8 | Traffic Class | **å…³é”®å­—æ®µ**ã€‚å¯¹åº” IB çš„ Service Level (SL) æˆ–ä¼˜å…ˆçº§ã€‚åœ¨æ—  VLAN æ ‡ç­¾æ—¶ï¼Œäº¤æ¢æœºæˆ–æ¥æ”¶ç«¯ä¾é æ­¤å­—æ®µè¿›è¡Œ QoS åˆ†ç±»å’Œ PFC æ˜ å°„ã€‚ |
| **Flow Label** | 20 | Flow Label | ç”¨äºåŒºåˆ†åŒä¸€æº-ç›®çš„å¯¹ä¹‹é—´çš„ä¸åŒæ•°æ®æµï¼Œä»¥æ­¤åœ¨æ”¯æŒ ECMP çš„ç½‘ç»œä¸­ä¿æŒåŒ…åºï¼Œé˜²æ­¢ä¹±åºåˆ°è¾¾ã€‚ |
| **Payload Length** | 16 | Payload Length | æŒ‡ç¤º GRH ä¹‹åçš„æ•°æ®é•¿åº¦ï¼ˆåŒ…æ‹¬ BTH å’Œè´Ÿè½½ï¼‰ã€‚ |
| **Next Header** | 8 | Next Header | æ ‡è¯†ä¸‹ä¸€ä¸ªå¤´éƒ¨çš„ç±»å‹ï¼Œé€šå¸¸æŒ‡å‘ BTHï¼ˆBase Transport Headerï¼‰ï¼Œå€¼ä¸º IB ä¼ è¾“åè®®å·ã€‚ |
| **Hop Limit** | 8 | Hop Limit | åœ¨ RoCE v1 ä¸­å®é™…æ„ä¹‰æœ‰é™ï¼Œå› ä¸ºä¸è·¨å­ç½‘ï¼Œä½†åœ¨ IB è¯­ä¹‰ä¸­ç”¨äºé™åˆ¶è·³æ•°ã€‚ |
| **Source GID** | 128 | Source Address | å‘é€ç«¯çš„ GIDã€‚åœ¨ RoCE v1 ä¸­ï¼Œé€šå¸¸åŸºäº MAC åœ°å€å’Œå­ç½‘å‰ç¼€ç”Ÿæˆï¼ˆç±»ä¼¼ IPv6 Link-Local åœ°å€ï¼‰ã€‚ |
| **Dest GID** | 128 | Dest Address | æ¥æ”¶ç«¯çš„ GIDã€‚ |

**æ·±å…¥æ´å¯Ÿ**ï¼šGRH çš„å­˜åœ¨æ­ç¤ºäº† RoCE v1 çš„è®¾è®¡å¦¥åâ€”â€”ä¸ºäº†è®©ä¸Šå±‚è½¯ä»¶ï¼ˆRDMA Verbsï¼‰æ— éœ€ä¿®æ”¹å³å¯è¿è¡Œåœ¨ä»¥å¤ªç½‘ä¸Šï¼Œåº•å±‚åè®®æ ˆä¼ªé€ äº†ä¸€ä¸ªâ€œç±»ä¼¼ InfiniBandâ€çš„ç¯å¢ƒï¼Œå³ä¿ç•™ GRH ä½¿å¾—ä¼ è¾“å±‚ä»¥ä¸ºè‡ªå·±åœ¨å¤„ç†æ ‡å‡†çš„ IB è·¯ç”±åŒ…ï¼Œå°½ç®¡ç‰©ç†ä¼ è¾“èµ°çš„æ˜¯ä»¥å¤ªç½‘ 4ã€‚

#### **2.2.3 åŸºç¡€ä¼ è¾“å¤´ (Base Transport Header, BTH)**

BTH æ˜¯å®ç° RDMA è¯­ä¹‰çš„æ ¸å¿ƒå¤´éƒ¨ï¼Œé•¿åº¦ä¸º 12 å­—èŠ‚ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®ä¿¡æ¯ 4ï¼š

* **OpCode (8 bits)**ï¼šæ“ä½œç ï¼ŒæŒ‡ç¤ºå½“å‰åŒ…æ˜¯ RDMA Writeã€Read è¿˜æ˜¯ Send æ“ä½œï¼Œä»¥åŠæ˜¯å¦æ˜¯ç«‹å³æ•°ï¼ˆImmediate Dataï¼‰æ“ä½œã€‚  
* **Solicited Event (SE)**ï¼šæŒ‡ç¤ºæ¥æ”¶ç«¯æ˜¯å¦éœ€è¦äº§ç”Ÿå®Œæˆé˜Ÿåˆ—äº‹ä»¶ï¼ˆCQEï¼‰ã€‚  
* **Partition Key (P\_Key, 16 bits)**ï¼šç”¨äºé€»è¾‘éš”ç¦»ï¼Œç±»ä¼¼äº VLAN IDï¼Œä½†åœ¨ IB å±‚é¢ä¸Šå®šä¹‰ã€‚  
* **Destination Queue Pair (Dest QP, 24 bits)**ï¼š**æ ¸å¿ƒå­—æ®µ**ã€‚æŒ‡å®šæ¥æ”¶ç«¯çš„é˜Ÿåˆ—å¶ï¼ˆQueue Pairï¼‰ç¼–å·ã€‚è¿™æ˜¯ RDMA é€šä¿¡çš„â€œç›®çš„ç«¯å£â€ï¼Œç¡¬ä»¶æ ¹æ®æ­¤å­—æ®µå°†æ•°æ®ç›´æ¥é€å…¥ç”¨æˆ·æ€å†…å­˜ï¼Œæ— éœ€å†…æ ¸å¹²é¢„ã€‚  
* **Acknowledge Request (A)**ï¼šæŒ‡ç¤ºå‘é€ç«¯æ˜¯å¦è¯·æ±‚ ACK ç¡®è®¤ã€‚  
* **Packet Sequence Number (PSN, 24 bits)**ï¼šåŒ…åºåˆ—å·ï¼Œç”¨äºæ£€æµ‹ä¸¢åŒ…ã€é‡å¤åŒ…å’Œä¹±åºï¼Œæ˜¯å®ç°å¯é è¿æ¥ï¼ˆReliable Connection, RCï¼‰çš„åŸºç¡€ã€‚

#### **2.2.4 æ ¡éªŒåºåˆ— (ICRC & FCS)**

* **ICRC (Invariant CRC)**ï¼š4 å­—èŠ‚ã€‚è¦†ç›– GRH å’Œ BTH ä¸­ä¸å˜çš„å­—æ®µï¼Œç¡®ä¿ç«¯åˆ°ç«¯çš„æ•°æ®å®Œæ•´æ€§ï¼Œé˜²æ­¢æ•°æ®åœ¨äº¤æ¢æœºå†…éƒ¨è¢«é”™è¯¯ä¿®æ”¹ 7ã€‚  
* **FCS (Frame Check Sequence)**ï¼š4 å­—èŠ‚ã€‚æ ‡å‡†çš„ä»¥å¤ªç½‘å°¾éƒ¨æ ¡éªŒï¼Œç”¨äºé“¾è·¯å±‚çš„é”™è¯¯æ£€æµ‹ã€‚

### **2.3 å¯»å€æœºåˆ¶ä¸æ—  ARP ç‰¹æ€§**

RoCE v1 çš„å¯»å€æ˜¯ä¸€ä¸ªè·¨å±‚æ˜ å°„è¿‡ç¨‹ã€‚

* **GID ä¸ MAC çš„æ˜ å°„**ï¼šRDMA åº”ç”¨å±‚ä½¿ç”¨ GIDï¼ˆ128ä½ï¼‰å»ºç«‹è¿æ¥ï¼ˆQueue Pairï¼‰ã€‚ä½†åœ¨é“¾è·¯å±‚ï¼Œä»¥å¤ªç½‘äº¤æ¢æœºåªè®¤ MAC åœ°å€ï¼ˆ48ä½ï¼‰ã€‚åœ¨ RoCE v1 ä¸­ï¼Œæº GID é€šå¸¸æ˜¯æ ¹æ®æº MAC åœ°å€æŒ‰ç…§ EUI-64 è§„åˆ™ç”Ÿæˆçš„ï¼ˆä¾‹å¦‚ fe80::...mac...ï¼‰ã€‚æ¥æ”¶ç«¯å¿…é¡»èƒ½å¤Ÿä»ç›®æ ‡ GID æ¨å¯¼å‡ºç›®æ ‡ MAC åœ°å€ï¼Œæˆ–è€…åœ¨å»ºç«‹è¿æ¥ï¼ˆQP æ¡æ‰‹ï¼‰é˜¶æ®µé€šè¿‡å¸¦å¤–ç®¡ç†ï¼ˆConnection Managerï¼‰äº¤æ¢ MAC åœ°å€ä¿¡æ¯ã€‚  
* **æ—  ARP**ï¼šç”±äºæ²¡æœ‰ IP å±‚ï¼ŒRoCE v1 ä¸ä½¿ç”¨ ARP åè®®è§£æ MACã€‚è¿™æ„å‘³ç€åœ¨ä»¿çœŸå®ç°ä¸­ï¼ŒèŠ‚ç‚¹å¿…é¡»é€šè¿‡é™æ€é…ç½®æˆ– Side-channelï¼ˆå¦‚ TCP æ¡æ‰‹äº¤æ¢ä¿¡æ¯ï¼‰é¢„å…ˆè·çŸ¥å¯¹ç«¯çš„ MAC åœ°å€ï¼Œå¹¶å°†å…¶å¡«å…¥ä»¥å¤ªç½‘å¸§å¤´ 1ã€‚

### **2.4 é“¾è·¯å±‚æµæ§ï¼šPFC (Priority Flow Control)**

RoCE v1 å¯¹ä¸¢åŒ…æå…¶æ•æ„Ÿã€‚ä¼ ç»Ÿçš„ TCP å¯ä»¥å®¹å¿ä¸¢åŒ…å¹¶é‡ä¼ ï¼Œä½† RDMA çš„é«˜æ€§èƒ½å»ºç«‹åœ¨â€œæ— æŸç½‘ç»œâ€ï¼ˆLossless Networkï¼‰å‡è®¾ä¹‹ä¸Šã€‚

* **PFC æœºåˆ¶**ï¼šRoCE v1 ä¾èµ– IEEE 802.1Qbb ä¼˜å…ˆçº§æµæ§ï¼ˆPFCï¼‰ã€‚å½“äº¤æ¢æœºå…¥å£ç¼“å†²åŒºçš„æŸä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆå¯¹åº” GRH Traffic Classï¼‰è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œäº¤æ¢æœºä¼šå‘ä¸Šä¸€è·³å‘é€ PAUSE å¸§ï¼Œæš‚åœè¯¥ä¼˜å…ˆçº§çš„æµé‡å‘é€ 4ã€‚  
* **æ‹¥å¡æ§åˆ¶ç¼ºå¤±**ï¼šä¸ RoCE v2 æ”¯æŒåŸºäº IP ECN çš„ç«¯åˆ°ç«¯æ‹¥å¡æ§åˆ¶ï¼ˆå¦‚ DCQCNï¼‰ä¸åŒï¼ŒRoCE v1 ç¼ºä¹ç½‘ç»œå±‚çš„æ‹¥å¡æ„ŸçŸ¥èƒ½åŠ›ã€‚å®ƒå®Œå…¨ä¾èµ–é“¾è·¯å±‚çš„â€œèƒŒå‹â€ï¼ˆBackpressureï¼‰æœºåˆ¶ã€‚è¿™åœ¨ä»¿çœŸä¸­æ„å‘³ç€å¿…é¡»ä¸¥æ ¼å®ç°åŸºäºé˜Ÿåˆ—æ·±åº¦çš„ PAUSE å¸§è§¦å‘é€»è¾‘ï¼Œè€Œä¸èƒ½ä½¿ç”¨ ECN æ ‡è®° 1ã€‚

## ---

**3\. å¼€æºä»£ç  ns3-rdma (v2) çš„æ¶æ„å‰–æ**

ä¸ºäº†å°†åŸºäº RoCE v2 çš„ ns3-rdma é¡¹ç›®ä¿®æ”¹ä¸º v1 ç‰ˆæœ¬ï¼Œå¿…é¡»é¦–å…ˆé€å½»ç†è§£ç°æœ‰ä»£ç çš„æ¶æ„ï¼Œç‰¹åˆ«æ˜¯å®ƒæ˜¯å¦‚ä½•åˆ©ç”¨ ns-3 çš„ UDP/IP åè®®æ ˆæ¥æ¨¡æ‹Ÿ RDMA çš„ã€‚è¯¥é¡¹ç›®ç”± Microsoft ç ”ç©¶å‘˜ Bob Zhu å¼€å‘ï¼Œæ—¨åœ¨æ¨¡æ‹Ÿæ•°æ®ä¸­å¿ƒç½‘ç»œä¸­çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼ˆDCQCN, TIMELYï¼‰ 11ã€‚

### **3.1 æ ¸å¿ƒç»„ä»¶ä¸æ–‡ä»¶ç»“æ„**

é€šè¿‡åˆ†æé¡¹ç›®æºç  11ï¼Œæˆ‘ä»¬å¯ä»¥è¯†åˆ«å‡ºä»¥ä¸‹å‡ ä¸ªå…³é”®æ¨¡å—ï¼Œå®ƒä»¬æ˜¯ä¿®æ”¹å·¥ä½œçš„é‡ç‚¹å¯¹è±¡ï¼š

1. **æµé‡ç”Ÿæˆç«¯ (applications/model/udp-echo-client.cc)**ï¼š  
   * **ç°çŠ¶**ï¼šè¿™æ˜¯ä¸€ä¸ªç»è¿‡ä¿®æ”¹çš„ UDP Clientã€‚å®ƒä½¿ç”¨ UdpSocketFactory åˆ›å»º socketï¼Œè¿™æ„å‘³ç€å®ƒç”Ÿæˆçš„æ•°æ®åŒ…ä¼šè‡ªåŠ¨ç»è¿‡ ns-3 çš„ UDP å±‚å’Œ IP å±‚ï¼Œè¢«åŠ ä¸Š UDP å¤´å’Œ IP å¤´ã€‚  
   * **v2 ç‰¹å¾**ï¼šä»£ç ä¸­é€šè¿‡ SetTosï¼ˆType of Serviceï¼‰è®¾ç½® IP ä¼˜å…ˆçº§ï¼Œç”¨äºæ¨¡æ‹Ÿ RDMA çš„ Traffic Classã€‚  
   * **é—®é¢˜**ï¼šRoCE v1 ä¸éœ€è¦ UDP å’Œ IP å¤´ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨ UdpSocketã€‚  
2. **ç½‘ç»œè®¾å¤‡ä¸æµæ§ (point-to-point/model/qbb-net-device.cc)**ï¼š  
   * **ç°çŠ¶**ï¼šå®ç°äº†æ”¯æŒ PFC çš„ç½‘ç»œè®¾å¤‡ï¼ˆQBB å³ 802.1Qbbï¼‰ã€‚å®ƒç›‘å¬æ¥æ”¶é˜Ÿåˆ—çš„æ·±åº¦ï¼Œå¹¶å‘é€ PAUSE å¸§ã€‚  
   * **v2 ç‰¹å¾**ï¼šå®ƒå¯èƒ½é€šè¿‡è¯»å– IP åŒ…å¤´çš„ DSCP/TOS å­—æ®µæ¥å°†åŒ…æ˜ å°„åˆ°ä¸åŒçš„ç¡¬ä»¶é˜Ÿåˆ—ã€‚  
   * **å…³é”®ç‚¹**ï¼šå¯¹äº v1ï¼Œè®¾å¤‡å¿…é¡»èƒ½å¤Ÿè¯†åˆ« EtherType 0x8915 çš„å¸§ï¼Œå¹¶ä» GRH æˆ– VLAN æ ‡ç­¾ä¸­æå–ä¼˜å…ˆçº§ï¼Œè€Œä¸æ˜¯æŸ¥çœ‹ IP å¤´ã€‚  
3. **äº¤æ¢æœºæ¨¡å‹ (network/model/broadcom-node.cc)**ï¼š  
   * **ç°çŠ¶**ï¼šæ¨¡æ‹Ÿ Broadcom èŠ¯ç‰‡çš„å…±äº«ç¼“å­˜æ¶æ„ã€‚å®ƒå®ç°äº† ECN æ ‡è®°é€»è¾‘ï¼ˆThresholdMarkECNï¼‰ã€‚  
   * **v2 ç‰¹å¾**ï¼šå½“é˜Ÿåˆ—è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œä¿®æ”¹ IP å¤´çš„ ECN ä½ã€‚  
   * **v1 é€‚é…éœ€æ±‚**ï¼šRoCE v1 æ²¡æœ‰ IP å¤´ï¼Œå› æ­¤å¿…é¡»ç¦ç”¨ ECN æ ‡è®°é€»è¾‘ï¼Œä»…ä¿ç•™ PFC è§¦å‘é€»è¾‘ 11ã€‚  
4. **è‡ªå®šä¹‰å¤´éƒ¨ (internet/model/seq-ts-header.cc)**ï¼š  
   * **ç°çŠ¶**ï¼šä½œè€…å®ç°äº†ä¸€ä¸ªç®€åŒ–çš„å¤´éƒ¨ï¼Œä»…åŒ…å«åºåˆ—å·ï¼ˆSequence Numberï¼‰å’Œæ—¶é—´æˆ³ï¼ˆTimestampï¼‰ï¼Œç”¨äºæµ‹é‡ååé‡å’Œ RTTï¼ˆé’ˆå¯¹ TIMELY ç®—æ³•ï¼‰ã€‚  
   * **ç¼ºå¤±**ï¼šé¡¹ç›®ä¸­å¹¶æ²¡æœ‰å®Œæ•´çš„ GRH å’Œ BTH å¤´éƒ¨ç±»ã€‚åœ¨ v2 ä»¿çœŸä¸­ï¼Œè¿™äº›ä¿¡æ¯éšå«åœ¨ UDP/IP å¤´æˆ–åº”ç”¨å±‚ Payload ä¸­ã€‚ä½†åœ¨ v1 ä»¿çœŸä¸­ï¼Œå¿…é¡»æ˜¾å¼æ„å»º GRH å’Œ BTH å¤´éƒ¨ï¼Œå› ä¸ºç‰©ç†çº¿è·¯ä¸Šå¿…é¡»å­˜åœ¨è¿™äº›å­—èŠ‚ã€‚

### **3.2 ç°æœ‰æ•°æ®æµåˆ†æ**

åœ¨ ns3-rdma (v2) ä¸­ï¼Œä¸€ä¸ª RDMA Write æ“ä½œçš„æ•°æ®æµå¦‚ä¸‹ï¼š

1. **App** è°ƒç”¨ Send() \-\> ä¼ å…¥ Payload \+ SeqTsHeaderã€‚  
2. **L4**ï¼šns-3 æ·»åŠ  UDP å¤´ï¼ˆæº/ç›®çš„ç«¯å£ 4791ï¼‰ã€‚  
3. **L3**ï¼šns-3 æ·»åŠ  IP å¤´ï¼ˆæº/ç›®çš„ IPï¼ŒECN ä½ï¼ŒProtocol=UDPï¼‰ã€‚  
4. **L2**ï¼šns-3 æ·»åŠ  Ethernet å¤´ï¼ˆEtherType \= 0x0800 IPv4ï¼‰ã€‚  
5. **ç‰©ç†å±‚**ï¼šä¼ è¾“ã€‚

**RoCE v1 çš„ç›®æ ‡æ•°æ®æµ**å¿…é¡»å˜ä¸ºï¼š

1. **App** æ‰‹åŠ¨æ„å»º GRH \+ BTH \+ Payloadã€‚  
2. **Socket**ï¼šç›´æ¥è°ƒç”¨ L2 æ¥å£ï¼ˆPacketSocketï¼‰ã€‚  
3. **L2**ï¼šns-3 æ·»åŠ  Ethernet å¤´ï¼ˆEtherType \= 0x8915ï¼‰ã€‚  
4. **ç‰©ç†å±‚**ï¼šä¼ è¾“ã€‚

## ---

**4\. RoCE v1 ä»¿çœŸä¿®æ”¹å®æˆ˜æŒ‡å— (åˆæ­¥æ–¹æ¡ˆï¼Œæœªæ ¡éªŒ)**

æœ¬èŠ‚è¯¦ç»†é˜è¿°å¦‚ä½•æ ¹æ® ns3-rdma é¡¹ç›®ä¿®æ”¹å¾—åˆ° RoCE v1 ç‰ˆæœ¬çš„ä»¿çœŸã€‚è¿™éœ€è¦ä»åº”ç”¨å±‚ Socket ç±»å‹ã€åŒ…å¤´æ„é€ åˆ°ä¸­é—´èŠ‚ç‚¹å¤„ç†é€»è¾‘çš„å…¨æ–¹ä½æ”¹é€ ã€‚

### **4.1 æ­¥éª¤ä¸€ï¼šSocket é€šä¿¡æœºåˆ¶çš„é‡æ„ (ä» UDP åˆ° Raw Ethernet)**

è¿™æ˜¯æœ€æ ¸å¿ƒçš„ä¿®æ”¹ã€‚RoCE v1 ä¸ä½¿ç”¨ IP å¯»å€ï¼Œå› æ­¤å¿…é¡»æ”¾å¼ƒ UdpSocketFactoryï¼Œè½¬è€Œä½¿ç”¨ ns-3 æä¾›çš„ PacketSocketFactoryã€‚PacketSocket å…è®¸åº”ç”¨ç¨‹åºç›´æ¥æ“ä½œé“¾è·¯å±‚å¸§ï¼Œç»•è¿‡ç½‘ç»œå±‚åè®®æ ˆ 13ã€‚

#### **4.1.1 ä¿®æ”¹ udp-echo-client.cc (å»ºè®®é‡å‘½åä¸º roce-client.cc)**

**åŸå§‹ä»£ç  (v2)**:

C++

// å…¸å‹çš„ UDP Socket åˆ›å»º  
TypeId tid \= TypeId::LookupByName ("ns3::UdpSocketFactory");  
m\_socket \= Socket::CreateSocket (GetNode (), tid);  
m\_socket-\>Bind ();  
m\_socket-\>Connect (InetSocketAddress (m\_peerAddress, m\_peerPort)); // ä½¿ç”¨ IP åœ°å€

**ä¿®æ”¹åä»£ç  (v1)**:

C++

// å¼•å…¥å¿…è¦çš„å¤´æ–‡ä»¶  
\#**include** "ns3/packet-socket-factory.h"  
\#**include** "ns3/packet-socket-address.h"

// 1\. åˆ›å»º PacketSocket  
TypeId tid \= TypeId::LookupByName ("ns3::PacketSocketFactory");  
m\_socket \= Socket::CreateSocket (GetNode (), tid);

// 2\. å‡†å¤‡ç‰©ç†åœ°å€ (MAC) å’Œ EtherType  
PacketSocketAddress socketAddr;  
socketAddr.SetSingleDevice (m\_netDevice-\>GetIfIndex()); // ç»‘å®šåˆ°ç‰¹å®šçš„ç½‘ç»œè®¾å¤‡æ¥å£  
socketAddr.SetPhysicalAddress (m\_destMacAddress);      // è®¾ç½®ç›®çš„ MAC åœ°å€ (éœ€é¢„å…ˆè·çŸ¥)  
socketAddr.SetProtocol (0x8915);                       // \*\*å…³é”®\*\*ï¼šè®¾ç½® EtherType ä¸º RoCE v1

// 3\. ç»‘å®šä¸è¿æ¥  
m\_socket-\>Bind (socketAddr);  
m\_socket-\>Connect (socketAddr);

**æ·±åº¦è§£æ**ï¼š

* SetProtocol(0x8915)ï¼šè¿™ä¸€æ­¥è‡³å…³é‡è¦ã€‚å®ƒå‘Šè¯‰åº•å±‚çš„ NetDeviceï¼Œåœ¨å°è£…ä»¥å¤ªç½‘å¸§æ—¶ï¼Œç±»å‹å­—æ®µåº”å¡«å…¥ 0x8915 16ã€‚  
* **MAC åœ°å€è·å–**ï¼šåœ¨ v2 ä¸­ï¼Œç”¨æˆ·æä¾› IPï¼Œç³»ç»Ÿé€šè¿‡ ARP è§£æ MACã€‚åœ¨ v1 ä»¿çœŸä¸­ï¼Œåˆ™éœ€è¦åœ¨ä»¿çœŸè„šæœ¬ä¸­ï¼Œæ˜¾å¼åœ°å°†æ¥æ”¶èŠ‚ç‚¹çš„ MAC åœ°å€ä¼ é€’ç»™å‘é€èŠ‚ç‚¹çš„ Applicationã€‚å¯ä»¥é€šè¿‡ node-\>GetDevice(0)-\>GetAddress() è·å– MACã€‚

### **4.2 æ­¥éª¤äºŒï¼šRoCE ä¸“ç”¨å¤´éƒ¨ç±»çš„å®ç° (C++)**

ç”±äº PacketSocket ä¸ä¼šæ·»åŠ ä»»ä½•ä¸Šå±‚å¤´éƒ¨ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å®ç° GRH å’Œ BTH çš„åºåˆ—åŒ–ç±»ï¼Œå¹¶ç»§æ‰¿è‡ª ns3::Headerã€‚è¿™ç›´æ¥å›åº”äº†ç”¨æˆ·å…³äºâ€œåè®®å†…å®¹å¦‚ä½•å¯¹åº”ä»£ç â€çš„é—®é¢˜ã€‚

#### **4.2.1 å®ç° GRH å¤´éƒ¨ (RoceGrhHeader)**

åœ¨ src/internet/model/ ä¸‹æ–°å»º roce-grh-header.h/ccã€‚è¯¥ç±»éœ€æ¨¡æ‹Ÿ IPv6 å¤´éƒ¨çš„ä½å¸ƒå±€ 18ã€‚

C++

// roce-grh-header.h æ¦‚è§ˆ  
class RoceGrhHeader : public Header {  
public:  
  //... æ ‡å‡† ns-3 Header æ–¹æ³•å£°æ˜...  
  void SetTrafficClass (uint8\_t tclass);  
  void SetFlowLabel (uint32\_t flowLabel);  
  void SetSourceGid (Ipv6Address gid); // ä½¿ç”¨ Ipv6Address ç±»æ¥å­˜å‚¨ 128ä½ GID  
  void SetDestGid (Ipv6Address gid);

private:  
  uint32\_t m\_flowLabel; // 20 bits  
  uint8\_t m\_tclass;     // 8 bits  
  uint8\_t m\_hopLimit;  
  Ipv6Address m\_sGid;  
  Ipv6Address m\_dGid;  
};

åºåˆ—åŒ–é€»è¾‘ (Serialize)ï¼š  
RoCE v1 è¦æ±‚å­—èŠ‚åºä¸ºç½‘ç»œåºï¼ˆBig Endianï¼‰ã€‚åœ¨ Serialize å‡½æ•°ä¸­ï¼Œå¿…é¡»å°†å­—æ®µæŒ‰ä½æ‹¼æ¥ï¼š

C++

// å¯¹åº” IPv6 å¤´éƒ¨çš„ç¬¬ä¸€ä¸ª 32ä½å­—ï¼šVersion(4) \+ TrafficClass(8) \+ FlowLabel(20)  
uint32\_t vtf \= (6 \<\< 28) | (m\_tclass \<\< 20) | (m\_flowLabel & 0xFFFFF);  
i.WriteHtonU32 (vtf);   
i.WriteHtonU16 (m\_payloadLen);  
i.WriteU8 (m\_nextHeader); // é€šå¸¸æŒ‡å‘ BTH  
i.WriteU8 (m\_hopLimit);  
// å†™å…¥ GID  
WriteTo (i, m\_sGid);  
WriteTo (i, m\_dGid);

**å¯¹åº”å…³ç³»**ï¼šè¿™é‡Œçš„ WriteHtonU32 æ“ä½œç›´æ¥å¯¹åº”äº†åè®®è§„èŒƒä¸­ GRH å¤´éƒ¨å‰ 4 ä¸ªå­—èŠ‚çš„å®šä¹‰ã€‚

#### **4.2.2 å®ç° BTH å¤´éƒ¨ (RoceBthHeader)**

æ–°å»º roce-bth-header.h/ccã€‚

C++

class RoceBthHeader : public Header {  
private:  
  uint8\_t m\_opcode;      // 8 bits  
  bool m\_solicitedEvent; // 1 bit  
  bool m\_migReq;         // 1 bit  
  uint16\_t m\_pkey;       // 16 bits  
  uint32\_t m\_destQp;     // 24 bits (éœ€ç‰¹æ®Šå¤„ç†)  
  bool m\_ackReq;         // 1 bit  
  uint32\_t m\_psn;        // 24 bits  
};

åºåˆ—åŒ–ç»†èŠ‚ï¼š  
BTH çš„å­—æ®µè·¨è¶Šå­—èŠ‚è¾¹ç•Œï¼Œä¾‹å¦‚ DestQP æ˜¯ 24 ä½ã€‚åºåˆ—åŒ–æ—¶éœ€è¦ä½æ“ä½œæŠ€å·§ï¼š

C++

i.WriteU8 (m\_opcode);  
// SE (1) \+ M (1) \+ Pad (2) \+ TVer (4)  
i.WriteU8 (flags);   
i.WriteHtonU16 (m\_pkey);  
// DestQP (24 bits) \+ AckReq (1 bit) \+ Reserved (7 bits)  
// è¿™é€šå¸¸éœ€è¦å°† DestQP æ”¾å…¥ä¸€ä¸ª 32ä½ æ•´æ•°çš„é«˜ 24 ä½  
i.WriteHtonU32 (m\_destQp \<\< 8 | m\_ackReq \<\< 7);  
i.WriteHtonU32 (m\_psn); // æ³¨æ„ PSN ä¹Ÿæ˜¯ 24ä½ï¼Œå®é™…ä¸Šåªå  3å­—èŠ‚ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†éœ€æŸ¥é˜…å…·ä½“å­—èŠ‚å¯¹é½

(æ³¨ï¼šæ ¹æ® IB è§„èŒƒï¼ŒBTH é•¿åº¦å›ºå®šä¸º 12 å­—èŠ‚ï¼Œä¸Šè¿°ä»£ç éœ€ä¸¥æ ¼å¯¹ç…§ä½å›¾å®ç° 4)ã€‚

### **4.3 æ­¥éª¤ä¸‰ï¼šä¿®æ”¹äº¤æ¢æœºä¸æµæ§é€»è¾‘ (broadcom-node.cc)**

è¿™æ˜¯ä»¿çœŸèƒ½å¦æ­£ç¡®åæ˜  v1 è¡Œä¸ºçš„å…³é”®ã€‚

1. **ç¦ç”¨ IP è§£æ**ï¼šåŸä»£ç å¯èƒ½ä¼šå°è¯• packet-\>PeekHeader\<Ipv4Header\>(ipHeader) æ¥æ£€æŸ¥ ECN ä½ã€‚åœ¨ v1 æ¨¡å¼ä¸‹ï¼Œè¿™ä¼šå¤±è´¥æˆ–è¯»åˆ°åƒåœ¾æ•°æ®ã€‚  
   * **ä¿®æ”¹**ï¼šç§»é™¤æ‰€æœ‰ ECN ç›¸å…³çš„ IP å±‚æ“ä½œã€‚  
   * **æ›¿ä»£**ï¼šå¦‚æœéœ€è¦åŸºäºä¼˜å…ˆçº§è¿›è¡Œæµæ§ï¼Œåº” PeekHeader\<RoceGrhHeader\> å¹¶è¯»å– Traffic Class å­—æ®µã€‚  
2. **PFC è§¦å‘é€»è¾‘**ï¼š  
   * ä¿ç•™ qbb-net-device ä¸­åŸºäºé˜Ÿåˆ—æ·±åº¦çš„ PAUSE å¸§å‘é€é€»è¾‘ã€‚  
   * ç¡®ä¿ RoceGrhHeader ä¸­çš„ Traffic Class è¢«æ­£ç¡®æ˜ å°„åˆ° qbb-net-device çš„ Traffic Category (TC)ã€‚ä¾‹å¦‚ï¼ŒGRH TClass 5 æ˜ å°„åˆ° TC 5ã€‚è¿™é€šå¸¸éœ€è¦åœ¨ NetDevice çš„å…¥é˜Ÿï¼ˆEnqueueï¼‰å‡½æ•°ä¸­é€šè¿‡ Packet::PeekHeader å®ç°åˆ†ç±»ã€‚

### **4.4 æ­¥éª¤å››ï¼šä»¿çœŸè„šæœ¬é…ç½® (third.cc)**

åœ¨ä¸»æ§è„šæœ¬ä¸­ï¼Œå¿…é¡»å»ºç«‹çº¯äºŒå±‚çš„ç½‘ç»œæ‹“æ‰‘ã€‚

1. **æ‹“æ‰‘é™åˆ¶**ï¼šæ‰€æœ‰èŠ‚ç‚¹å¿…é¡»åœ¨åŒä¸€ä¸ª NodeContainer ä¸­ï¼Œé€šè¿‡ CsmaHelper æˆ– PointToPointHelper è¿æ¥ï¼Œä¸”ä¸èƒ½é…ç½® IP åœ°å€ï¼ˆæˆ–è€…é…ç½®äº†ä¹Ÿä¸ä½¿ç”¨ï¼‰ã€‚  
2. **å®‰è£…åº”ç”¨**ï¼šå°†ä¿®æ”¹åçš„ RoceClient åº”ç”¨å®‰è£…åˆ°èŠ‚ç‚¹ï¼Œå¹¶æ‰‹åŠ¨å¡«å…¥å¯¹ç«¯çš„ MAC åœ°å€ä½œä¸ºâ€œç‰©ç†åœ°å€â€ã€‚

## ---

**5\. åè®®å†…å®¹ä¸ä»¿çœŸä»£ç çš„æ˜ å°„å…³ç³»æ€»ç»“**

ä¸ºäº†æ¸…æ™°å›ç­”ç”¨æˆ·çš„ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œä¸‹è¡¨æ€»ç»“äº† RoCE v1 åè®®å­—æ®µä¸ ns-3 ä»¿çœŸä»£ç çš„å…·ä½“å¯¹åº”å…³ç³»ï¼š

| åè®®å±‚çº§ | åè®®å­—æ®µ (Protocol Content) | ns-3 ä»¿çœŸä»£ç å¯¹åº” (Simulation Implementation) | ä½œç”¨ä¸å¤‡æ³¨ |
| :---- | :---- | :---- | :---- |
| **é“¾è·¯å±‚** | **EtherType** | PacketSocketAddress::SetProtocol(0x8915) | **æ ¸å¿ƒæ ‡è¯†**ã€‚æŒ‡ç¤º NetDevice å°è£…å¸§æ—¶å†™å…¥ 0x8915ï¼Œä½¿äº¤æ¢æœºè¯†åˆ«ä¸º RoCE æµé‡ã€‚ |
| **é“¾è·¯å±‚** | **Dest MAC** | PacketSocketAddress::SetPhysicalAddress(mac) | æ›¿ä»£äº† ARP è¿‡ç¨‹ï¼Œç›´æ¥æŒ‡å®šé“¾è·¯å±‚ç›®çš„åœ°å€ã€‚ |
| **ç½‘ç»œå±‚** | **GRH: IP Version** | RoceGrhHeader::Serialize ä¸­å†™å…¥ 6 | æ¬ºéª—æ¥æ”¶ç«¯å¤„ç†é€»è¾‘ï¼Œä½¿å…¶è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„ IB GRHã€‚ |
| **ç½‘ç»œå±‚** | **GRH: Traffic Class** | RoceGrhHeader::m\_tclass | **æµæ§å…³é”®**ã€‚åœ¨äº¤æ¢æœº broadcom-node ä¸­ï¼Œè¯¥å­—æ®µå†³å®šåŒ…è¿›å…¥å“ªä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œä»è€Œå½±å“ PFC PAUSE å¸§çš„è§¦å‘ã€‚ |
| **ç½‘ç»œå±‚** | **GRH: Flow Label** | RoceGrhHeader::m\_flowLabel | å¯ç”¨äºä»¿çœŸä¸­çš„ ECMP å“ˆå¸Œè®¡ç®—ï¼ˆå¦‚æœå®ç°äº† L2 å¤šè·¯å¾„ï¼‰ã€‚ |
| **ç½‘ç»œå±‚** | **GRH: Source/Dest GID** | RoceGrhHeader::m\_sGid (Ipv6Address ç±»å‹) | ä»¿çœŸä¸­å¯ç›´æ¥å¡«å…¥èŠ‚ç‚¹çš„ MAC æ˜ å°„å€¼æˆ–è™šæ‹Ÿ IDï¼Œç”¨äºåº”ç”¨å±‚éªŒè¯è¿æ¥åˆæ³•æ€§ã€‚ |
| **ä¼ è¾“å±‚** | **BTH: OpCode** | RoceBthHeader::m\_opcode | æŒ‡ç¤ºæ˜¯ RDMA Write è¿˜æ˜¯ Readã€‚ä»¿çœŸæ¥æ”¶ç«¯æ®æ­¤å†³å®šæ˜¯å¦å‘é€ ACK æˆ–å›å†™æ•°æ®ã€‚ |
| **ä¼ è¾“å±‚** | **BTH: Dest QP** | RoceBthHeader::m\_destQp | æ¥æ”¶ç«¯åº”ç”¨æ®æ­¤å°†æ•°æ®åŒ…åˆ†å‘ç»™æ­£ç¡®çš„ Contextã€‚ |
| **ä¼ è¾“å±‚** | **BTH: PSN** | RoceBthHeader::m\_psn | ç”¨äºæ£€æµ‹ä¸¢åŒ…ã€‚qbb-net-device å¯èƒ½ä¼šç»Ÿè®¡ä¹±åºåŒ…ï¼ŒClient ç«¯åˆ©ç”¨æ­¤å­—æ®µå®ç° Go-Back-N é‡ä¼ ã€‚ |
| **æµæ§** | **PAUSE Frame** | qbb-net-device.cc ä¸­çš„ SendPfc() | å¯¹åº” 802.1Qbb æ ‡å‡†ã€‚ä»£ç ä¸­åŒ…å«ç”Ÿæˆç‰¹å®š EtherType (0x8808) æ§åˆ¶å¸§çš„é€»è¾‘ã€‚ |

## ---

**6\. éªŒè¯ä¸é«˜çº§è¯é¢˜**

### **6.1 Wireshark æŠ“åŒ…éªŒè¯**

ä¸ºäº†éªŒè¯ä»¿çœŸä»£ç æ˜¯å¦æ­£ç¡®ç”Ÿæˆäº† RoCE v1 æ•°æ®åŒ…ï¼Œå¯ä»¥ä½¿ç”¨ ns-3 çš„ PCAP è¿½è¸ªåŠŸèƒ½ (m\_netDevice-\>EnablePcapAll ("roce-v1"))ã€‚

* ç”Ÿæˆçš„ .pcap æ–‡ä»¶åº”èƒ½åœ¨ Wireshark ä¸­æ‰“å¼€ã€‚  
* å¦‚æœ SetProtocol(0x8915) æ­£ç¡®ï¼ŒWireshark ä¼šè‡ªåŠ¨è¯†åˆ«å¸§ä¸º RoCE (InfiniBand)ï¼Œå¹¶å°è¯•è§£æå…¶åçš„ GRH å’Œ BTHã€‚å¦‚æœçœ‹åˆ° IP å¤´æˆ– UDP å¤´ï¼Œè¯´æ˜ PacketSocket çš„ä½¿ç”¨æœ‰è¯¯æˆ–æœªæ­£ç¡®ç»•è¿‡ TCP/IP æ ˆ 21ã€‚

### **6.2 ä»¿çœŸä¸­çš„å¸¸è§é™·é˜±ï¼šPFC æ­»é”ä¸é£æš´**

RoCE v1 æåº¦ä¾èµ– PFCã€‚åœ¨ä»¿çœŸä¸­ï¼Œå¦‚æœä»…ä»…ä¾é  PFC è€Œæ²¡æœ‰ä¸Šå±‚æ‹¥å¡æ§åˆ¶ï¼ˆå¦‚ v2 çš„ DCQCNï¼‰ï¼Œåœ¨é«˜è´Ÿè½½ï¼ˆå¦‚ Incast æ¨¡å¼ï¼‰ä¸‹ææ˜“è§‚å¯Ÿåˆ°â€œPFC é£æš´â€æˆ–æ­»é”ï¼ˆHead-of-Line Blockingï¼‰ã€‚

* **ç°è±¡**ï¼šä»¿çœŸä¸­çš„ååé‡çªç„¶è·Œè‡³é›¶ï¼Œä¸”æ—¥å¿—æ˜¾ç¤ºå¤§é‡ PAUSE å¸§è¢«å‘é€ã€‚  
* **åˆ†æ**ï¼šè¿™æ­£æ˜¯ RoCE v1 çš„å…¸å‹ç‰¹å¾ã€‚é€šè¿‡è§‚å¯Ÿ qbb-net-device çš„ trace æ—¥å¿—ï¼Œå¯ä»¥ç ”ç©¶ PFC é˜ˆå€¼ï¼ˆm\_pfcThresholdï¼‰è®¾ç½®å¯¹ç½‘ç»œæ€§èƒ½çš„éçº¿æ€§å½±å“ï¼Œè¿™æ˜¯ RoCE v1 ä»¿çœŸçš„é‡è¦ç ”ç©¶ä»·å€¼æ‰€åœ¨ 10ã€‚

## **7\. ç»“è®º**

é€šè¿‡å¯¹ RoCE v1 åè®®çš„æ·±å…¥å‰–æå’Œå¯¹ ns3-rdma é¡¹ç›®çš„æ¶æ„è§£æ„ï¼Œæˆ‘ä»¬å¾—å‡ºç»“è®ºï¼šå®ç° RoCE v1 ä»¿çœŸçš„æ ¸å¿ƒåœ¨äº\*\*â€œå» IP åŒ–â€\*\*ã€‚è¿™ä¸ä»…æ¶‰åŠåˆ°ç®€å•åœ°ç§»é™¤ IP å¤´ï¼Œæ›´éœ€è¦ä» Socket ç¼–ç¨‹æ¨¡å‹ï¼ˆé‡‡ç”¨ PacketSocketï¼‰ã€å¸§ç»“æ„æ„é€ ï¼ˆæ‰‹åŠ¨åºåˆ—åŒ– GRH/BTHï¼‰ä»¥åŠæµæ§æœºåˆ¶ï¼ˆä»…ä¾èµ– PFCï¼‰ä¸‰ä¸ªç»´åº¦è¿›è¡Œç³»ç»Ÿæ€§æ”¹é€ ã€‚

æœ¬æŠ¥å‘Šæä¾›çš„å·¥ç¨‹æŒ‡å—å¡«è¡¥äº†ä»ç†è®ºåè®®åˆ°ä»£ç å®ç°çš„ç©ºç™½ï¼Œæ˜ç¡®äº†å¦‚ä½•åˆ©ç”¨ ns-3 å¼ºå¤§çš„é“¾è·¯å±‚ä»¿çœŸèƒ½åŠ›æ¥å¤ç° RoCE v1 è¿™ç§åŸºäºâ€œçº¯ä»¥å¤ªç½‘â€çš„é«˜æ€§èƒ½è®¡ç®—ç½‘ç»œåè®®ã€‚å¯¹äºç ”ç©¶æ•°æ®ä¸­å¿ƒç½‘ç»œæ¼”è¿›ã€æ— æŸä»¥å¤ªç½‘æœºåˆ¶åŠ PFC ç¼ºé™·çš„å­¦è€…è€Œè¨€ï¼Œè¿™ä¸€ä»¿çœŸå¹³å°çš„æ­å»ºå…·æœ‰é‡è¦çš„å‚è€ƒä»·å€¼ã€‚

#### **å¼•ç”¨çš„è‘—ä½œ**

1. RDMA over Converged Ethernet \- Wikipedia, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://en.wikipedia.org/wiki/RDMA\_over\_Converged\_Ethernet](https://en.wikipedia.org/wiki/RDMA_over_Converged_Ethernet)  
2. What is RoCE(RDMA over Converged Ethernet)ï¼Ÿ \- mvslinks.com, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://mvslinks.com/news/blog/what-is-rocerdma-over-converged-ethernet%EF%BC%9F/](https://mvslinks.com/news/blog/what-is-rocerdma-over-converged-ethernet%EF%BC%9F/)  
3. Understanding the RoCE network protocol, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://hustcat.github.io/roce-protocol/](https://hustcat.github.io/roce-protocol/)  
4. InfiniBand RDMA and RoCE Explained: Protocols, Messages, and Network Architecture | by NADDOD | Dec, 2025 | Medium, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://medium.com/@naddod/infiniband-rdma-and-roce-explained-protocols-messages-and-network-architecture-65b79eac6694](https://medium.com/@naddod/infiniband-rdma-and-roce-explained-protocols-messages-and-network-architecture-65b79eac6694)  
5. RDMA over Converged Ethernet (RoCE) \- NVIDIA Docs, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://docs.nvidia.com/networking/display/mlnxofedv23070512/rdma+over+converged+ethernet+(roce)](https://docs.nvidia.com/networking/display/mlnxofedv23070512/rdma+over+converged+ethernet+\(roce\))  
6. InfiniBand RDMA and RoCE Explained: Protocols, Messages, and Network Architecture, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://www.naddod.com/ai-insights/infiniband-rdma-and-roce-explained-protocols-messages-and-network-architecture](https://www.naddod.com/ai-insights/infiniband-rdma-and-roce-explained-protocols-messages-and-network-architecture)  
7. RoCE Vs InfiniBand: Key Differences, Performance & Use Cases \- Asterfusion, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://cloudswit.ch/blogs/roce-or-infiniband-technical-comparison/](https://cloudswit.ch/blogs/roce-or-infiniband-technical-comparison/)  
8. InfiniBand packet header and ibverbs interface implementation (I) â€” RDMA WRITE analysis | by DatenLord | Medium, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://medium.com/@datenlord/infiniband-packet-header-and-ibverbs-interface-implementation-i-rdma-write-analysis-1d626f94f61c](https://medium.com/@datenlord/infiniband-packet-header-and-ibverbs-interface-implementation-i-rdma-write-analysis-1d626f94f61c)  
9. Everything You Should Know About RoCE \- QSFPTEK, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://www.qsfptek.com/qt-news/everything-you-should-know-about-roce.html](https://www.qsfptek.com/qt-news/everything-you-should-know-about-roce.html)  
10. SwCC: Software-Programmable and Per-Packet Congestion Control in RDMA Engine \- USENIX, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://www.usenix.org/system/files/atc25-huang-hongjing.pdf](https://www.usenix.org/system/files/atc25-huang-hongjing.pdf)  
11. bobzhuyb/ns3-rdma: NS3 simulator for RDMA over Converged Ethernet v2 (RoCEv2), including the implementation of DCQCN, TIMELY, PFC, ECN and shared buffer switch \- GitHub, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://github.com/bobzhuyb/ns3-rdma](https://github.com/bobzhuyb/ns3-rdma)  
12. ns3-rdma \- Gitee, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://gitee.com/zm643/ns3-rdma?skip\_mobile=true](https://gitee.com/zm643/ns3-rdma?skip_mobile=true)  
13. Sockets APIs â€” Model Library \- ns-3, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://www.nsnam.org/docs/release/3.29/models/html/sockets-api.html](https://www.nsnam.org/docs/release/3.29/models/html/sockets-api.html)  
14. ns-3 manual: 5.1 ns-3 sockets API, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://www.nsnam.org/docs/release/3.1/manual/manual\_32.html](https://www.nsnam.org/docs/release/3.1/manual/manual_32.html)  
15. ns3::PacketSocket Class Reference \[Socket\], è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://www.nsnam.org/docs//release/3.9/doxygen/classns3\_1\_1\_packet\_socket.html](https://www.nsnam.org/docs//release/3.9/doxygen/classns3_1_1_packet_socket.html)  
16. ns3::PacketSocketAddress Class Reference \- ns-3, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://www.nsnam.org/docs/release/3.23/doxygen/classns3\_1\_1\_packet\_socket\_address.html](https://www.nsnam.org/docs/release/3.23/doxygen/classns3_1_1_packet_socket_address.html)  
17. ns3::PacketSocketAddress Class Reference, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://www.nsnam.org/docs/release/3.19/doxygen/classns3\_1\_1\_packet\_socket\_address.html](https://www.nsnam.org/docs/release/3.19/doxygen/classns3_1_1_packet_socket_address.html)  
18. LRH and GRH InfiniBand Headers \- NVIDIA Enterprise Support Portal, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://enterprise-support.nvidia.com/s/article/lrh-and-grh-infiniband-headers](https://enterprise-support.nvidia.com/s/article/lrh-and-grh-infiniband-headers)  
19. IPv4 vs IPv6 \- Understanding the differences | NetworkAcademy.IO, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://www.networkacademy.io/ccna/ipv6/ipv4-vs-ipv6](https://www.networkacademy.io/ccna/ipv6/ipv4-vs-ipv6)  
20. IPv6 packet \- Wikipedia, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://en.wikipedia.org/wiki/IPv6\_packet](https://en.wikipedia.org/wiki/IPv6_packet)  
21. How to use Wireshark to capture a packet trace \- Micro Focus Software Support, è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://support.microfocus.com/kb/doc.php?id=3892415](https://support.microfocus.com/kb/doc.php?id=3892415)  
22. How-To Dump RDMA Traffic Using the Inbox tcpdump tool (ConnectX-4 and above), è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://enterprise-support.nvidia.com/s/article/how-to-dump-rdma-traffic-using-the-inbox-tcpdump-tool--connectx-4-x](https://enterprise-support.nvidia.com/s/article/how-to-dump-rdma-traffic-using-the-inbox-tcpdump-tool--connectx-4-x)  
23. Introduction to Congestion Control for RoCE \- Broadcom Inc., è®¿é—®æ—¶é—´ä¸º åäºŒæœˆ 29, 2025ï¼Œ [https://docs.broadcom.com/docs/NCC-WP1XX](https://docs.broadcom.com/docs/NCC-WP1XX)